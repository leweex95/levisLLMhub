name: Nightly DeepSeek Test

on:
  schedule:
    - cron: "0 2 * * *"  # Run at 2 AM daily (different from ChatGPT test)
  workflow_dispatch:

jobs:
  nightly-deepseek-test:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      
      - name: Verify Node
        run: |
          node -v
          npm -v
        shell: pwsh
  
      - name: Install Poetry
        run: python -m pip install --upgrade poetry==2.2.0

      - name: Install dependencies
        run: |
          poetry install
        shell: pwsh

      - name: Install Node.js dependencies
        run: |
          npm install
        shell: pwsh

      - name: Validate textgenhub installation
        run: |
          poetry run pip show textgenhub
        shell: pwsh
  
      - name: Run DeepSeek regression test
        run: |
          $jsonOutput = node ./src/textgenhub/deepseek/deepseek_cli.js --prompt "What is 7 + 13? Answer with only the number, no text, no explanation, just the single number." --headless 2>$null | Select-String '^\{.*\}$' | ForEach-Object { $_.Line }
          $result = $jsonOutput | ConvertFrom-Json
          $expected_answer = "20"
          
          if ($result.response.Trim() -ne $expected_answer) {
              throw "Regression test failed: expected $expected_answer, got DeepSeek output: $($result.response)"
          } else {
              Write-Output "Regression test passed: expected $expected_answer, DeepSeek output: $($result.response)"
          }
        shell: pwsh

  notify:
      needs: nightly-deepseek-test 
      if: failure()
      runs-on: ubuntu-latest
      steps:
        - name: Send failure email
          uses: dawidd6/action-send-mail@v3
          with:
            server_address: smtp.gmail.com
            server_port: 587
            username: ${{ secrets.EMAIL_USERNAME }}
            password: ${{ secrets.EMAIL_PASSWORD }}
            subject: "ðŸš¨ [TextGen Github Project] Nightly DeepSeek Test Failed"
            html_body: |
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:22px; font-weight:bold; color:red;">
                ðŸš¨ Nightly DeepSeek Test Failed!
              </p>
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
                The DeepSeek math test (7+13=20) failed. This may indicate issues with the DeepSeek Chat interface or response extraction.
              </p>
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
                Check logs: <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                Workflow Run</a>
              </p>
            to: ${{ secrets.EMAIL_USERNAME }}
            from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>